<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="net.smarthaccp.demand.mapper.RequirementsMapper" >
	<select id="getRequestList" parameterType="SearchInfoVO" resultType="RequestVO">
		SELECT
			req_idx
			, type
			, title
			, RD.site_idx
			, SM.site_company_name
			, requester
			, DATE(request_date) as request_date
			, RD.state
			, priority
			, DATE(RD.create_date) as create_date
		FROM
			REQ_DOC_TB RD LEFT JOIN SITE_MASTER_TB SM
			ON RD.site_idx = SM.site_idx
		WHERE	
		<choose>
			<when test="searchType != null and !searchKeyword.equals('')">
				<choose>
					<when test="searchType.equals('any')">
						type like concat('%',#{searchKeyword},'%')
						OR title like concat('%',#{searchKeyword},'%')
						OR SM.site_company_name like concat('%',#{searchKeyword},'%')
						OR state like concat('%',#{searchKeyword},'%')
					</when>
					<when test="searchType.equals('type')">
						type like concat('%',#{searchKeyword},'%')
					</when>
					<when test="searchType.equals('title')">
						title like concat('%',#{searchKeyword},'%')
					</when>
					<when test="searchType.equals('company')">
						SM.site_company_name like concat('%',#{searchKeyword},'%')
					</when>
					<when test="searchType.equals('state')">
						state like concat('%',#{searchKeyword},'%')
					</when>
				</choose>
			</when>
			<otherwise>
				1=1
			</otherwise>
		</choose>
		<choose>
			<when test="startDate != null and endDate != null">
				<![CDATA[
					AND DATE(request_date) >= #{startDate}
					AND DATE(request_date) <= #{endDate}
				]]> 
			</when>
			<when test="endDate != null">
				<![CDATA[
					AND DATE(request_date) <= #{endDate}
				]]>
			</when>
			<when test="startDate != null">
				<![CDATA[
					AND DATE(request_date) >= #{startDate}
				]]>
			</when>
		</choose>
		<if test="startRow != null and listLimit != null">
			limit
				${startRow}
				, ${listLimit}
		</if>
	</select>
	<insert id="insertRequest" parameterType="RequestVO">
		INSERT INTO
			REQ_DOC_TB(req_idx,type,title,content,site_idx,requester,request_date,priority,file_idx)
			values(
				#{req_idx}
				, #{type}
				, #{title}
				, #{content}
				, #{site_idx}
				, #{requester}
				, #{request_date}
				, #{priority}
				, #{file_idx}
			)
	</insert>
	<update id="updateRequest" parameterType="RequestVO">
		UPDATE
			REQ_DOC_TB
	    <set>
			<if test="type != null and type !=''">
				type = ${type},	
			</if>	    
	    </set>
	    WHERE
	    	req_idx = ${req_idx}
	</update>
	<select id="selectRequest" resultType="RequestVO" parameterType="String">
		SELECT
			req_idx
			, type
			, title
			, content
			, RD.site_idx
			, SM.site_company_name
			, file_idx
			, requester
			, DATE(request_date) as request_date
			, RD.state
			, priority
			, DATE(RD.create_date) as create_date
		FROM
			REQ_DOC_TB RD LEFT JOIN SITE_MASTER_TB SM
			ON RD.site_idx = SM.site_idx
		WHERE
			req_idx = #{req_idx}
	</select>
</mapper>
